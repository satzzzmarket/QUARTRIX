<!doctype html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Dashboard - QUARTRIX</title>
    <link rel="icon" href="https://i.ibb.co.com/7xxVWwH7/IMG-8428.png" />

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Poppins", sans-serif;
      }

      body {
        background: #5a3e2b;
        color: #fff5e6;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      header {
        background: #ff8c42;
        padding: 1.5rem 2rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      header a {
        color: #fff5e6;
        text-decoration: none;
        letter-spacing: 2px;
      }

      .logout {
        background: #3e2c23;
        color: #fff;
        border: none;
        padding: 10px 18px;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
      }

      main {
        max-width: 1000px;
        margin: auto;
        padding: 2rem;
        flex: 1;
      }

      .card {
        background: #fff5e6;
        color: #3e2c23;
        border-radius: 16px;
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.35);
      }

      .card h2 {
        margin-bottom: 1rem;
        color: #5a3e2b;
      }

      ul {
        list-style: none;
      }

      li {
        padding: 10px;
        border-bottom: 1px solid #ddd;
        font-weight: 600;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      /* JADWAL MENARIK */
      #jadwalButtons {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
        margin-bottom: 1rem;
      }

      .hari-btn {
        background: #ff8c42;
        color: #fff;
        border: none;
        padding: 8px 16px;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
      }

      .hari-btn.active {
        background: #3e2c23;
      }

      #jadwalDetail {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
      }

      .jadwal-card {
        background: #f9f9f9;
        border: 1px solid #ddd;
        border-radius: 10px;
        padding: 1rem;
        text-align: center;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s;
      }

      .jadwal-card:hover {
        transform: translateY(-5px);
      }

      .jadwal-mapel {
        font-weight: 700;
        color: #ff8c42;
        font-size: 1.1rem;
        margin-bottom: 0.5rem;
      }

      .jadwal-waktu {
        color: #666;
        font-size: 0.9rem;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
      }

      .jadwal-waktu::before {
        content: "‚è∞";
        font-size: 1rem;
      }

      /* ADMIN */
      #adminPanel input,
      #tambahTugasPanel input {
        width: 100%;
        padding: 10px;
        margin: 0.4rem 0;
        border-radius: 8px;
        border: 1px solid #ccc;
      }

      button {
        cursor: pointer;
      }

      .hapus-btn {
        background: #e74c3c;
        color: #fff;
        border: none;
        padding: 5px 10px;
        border-radius: 5px;
        font-size: 0.8rem;
        cursor: pointer;
        margin-left: 10px;
      }

      .hapus-btn:hover {
        background: #c0392b;
      }

      /* TOMBOL MENARIK */
      .btn-menarik {
        background: linear-gradient(45deg, #ff8c42, #ff6b35);
        color: #fff;
        border: none;
        padding: 12px 24px;
        border-radius: 25px;
        font-weight: 700;
        font-size: 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(255, 140, 66, 0.4);
        position: relative;
        overflow: hidden;
      }

      .btn-menarik::before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.2),
          transparent
        );
        transition: left 0.5s;
      }

      .btn-menarik:hover::before {
        left: 100%;
      }

      .btn-menarik:hover {
        background: linear-gradient(45deg, #ff6b35, #e55a2b);
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(255, 140, 66, 0.6);
      }

      .btn-menarik:active {
        transform: translateY(0);
        box-shadow: 0 2px 10px rgba(255, 140, 66, 0.4);
      }

      .logo img {
        width: 48px;
        height: 48px;
        object-fit: contain;
        border-radius: 50%;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
        user-select: none;
      }

      /* TUGAS MENARIK */
      .tugas-card {
        background: #f9f9f9;
        border: 1px solid #ddd;
        border-radius: 10px;
        padding: 1rem;
        margin-bottom: 1rem;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }

      .tugas-mapel {
        font-weight: 700;
        color: #ff8c42;
        font-size: 1.1rem;
      }

      .tugas-desc {
        color: #333;
      }

      .tugas-deadline {
        color: #666;
        font-size: 0.9rem;
      }

      .tugas-admin {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .tugas-selesai {
        text-decoration: line-through;
        color: #999;
      }

      .checkbox {
        margin-right: 10px;
        width: 20px;
        height: 20px;
      }

      /* PROFIL */
      #info {
        display: flex;
        align-items: center;
        gap: 1rem;
      }

      .profil-foto {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        object-fit: cover;
        border: 2px solid #ff8c42;
      }

      .edit-profil-btn {
        background: #3498db;
        color: #fff;
        border: none;
        padding: 8px 16px;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        margin-left: auto;
      }

      .edit-profil-btn:hover {
        background: #2980b9;
      }

      #modalProfil {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        justify-content: center;
        align-items: center;
        z-index: 1000;
      }

      .modal-content {
        background: #5a3e2b;
        border-radius: 10px;
        padding: 2rem;
        max-width: 400px;
        width: 90%;
        text-align: center;
        color: #fff5e6;
        border: 2px solid #ff8c42;
      }

      .modal-content h2 {
        color: #ff8c42;
        margin-bottom: 1.5rem;
      }

      .modal-content input {
        margin: 0.5rem 0;
        width: 100%;
        padding: 10px;
        border-radius: 8px;
        border: 2px solid #ff8c42;
        background: #fff5e6;
        color: #3e2c23;
        font-weight: 600;
      }

      .modal-content input::placeholder {
        color: #999;
      }

      .modal-content label {
        display: block;
        text-align: left;
        margin-top: 0.5rem;
        font-weight: 600;
        color: #ff8c42;
      }

      .modal-content .keterangan {
        font-size: 0.8rem;
        color: #ccc;
        margin-bottom: 0.5rem;
        text-align: left;
      }

      /* File input styling */
      .file-input-wrapper {
        position: relative;
        margin: 0.5rem 0;
      }

      .file-input-wrapper input[type="file"] {
        display: none;
      }

      .file-input-label {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 12px;
        border-radius: 8px;
        border: 2px dashed #ff8c42;
        background: rgba(255, 140, 66, 0.1);
        color: #ff8c42;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
      }

      .file-input-label:hover {
        background: rgba(255, 140, 66, 0.2);
        border-style: solid;
      }

      .file-input-label::before {
        content: "üìÅ ";
        font-size: 1.2rem;
      }

      .filename-display {
        display: block;
        margin-top: 0.5rem;
        padding: 8px 12px;
        background: #ff8c42;
        color: #fff;
        border-radius: 8px;
        font-weight: 600;
        font-size: 0.9rem;
        text-align: left;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      .filename-display::before {
        content: "üìé ";
      }

      .no-file {
        color: #ccc;
        font-style: italic;
      }

      .modal-content button {
        margin-top: 1rem;
      }

      .close-modal {
        position: absolute;
        top: 10px;
        right: 10px;
        background: #e74c3c;
        color: #fff;
        border: none;
        padding: 5px 10px;
        border-radius: 50%;
        cursor: pointer;
      }

      /* INFO MENARIK */
      #infoText {
        font-size: 1.2rem;
        font-weight: 700;
        color: #ff8c42;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        animation: fadeIn 1s ease-in;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }

        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      footer {
        text-align: center;
        padding: 1rem;
        background: #3e2c23;
      }

      /* DAFTAR SISWA */
      #daftarSiswa ul {
        list-style: none;
        padding: 0;
      }

      #daftarSiswa li {
        display: flex;
        justify-content: space-between;
        padding: 10px;
        border-bottom: 1px solid #ddd;
      }
    </style>
  </head>

  <body>
    <header>
      <div class="logo">
        <img
          src="https://i.ibb.co.com/7xxVWwH7/IMG-8428.png"
          alt="Logo QUARTRIX"
        />
      </div>
      <h1><a href="index.html">QUARTRIX</a></h1>
      <button class="logout">Logout</button>
    </header>

    <main>
      <div class="card">
        <div id="info">
          <img
            id="profilFoto"
            src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNTAiIHZpZXdCb3g9IjAgMCA1MCA1MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjUiIGN5PSIyNSIgcj0iMjUiIGZpbGw9IiNmZmY1ZTYiLz4KPHBhdGggZD0iTTI1IDI1QzI3LjIgMjUgMjkgMjIuMiAyOSAyMEMyOSAxNy44IDI3LjIgMTYgMjUgMTZDMTYuOCAxNiAxNSAxNy44IDE1IDIwQzE1IDIyLjIgMTYuOCAyNSAyNSAyNVoiIGZpbGw9IiMzZTJjMjMiLz4KPHBhdGggZD0iTTMwIDI1QzMwIDI4LjMgMjduMyAzMSAyNSAzMUMyMi43IDMxIDIwIDI4LjMgMjAgMjVDMjAgMjEuNyAyMi43IDE5IDI1IDE5QzI3LjMgMTkgMzAgMjEuNyAzMCAyNVoiIGZpbGw9IiMzZTJjMjMiLz4KPC9zdmc+"
            alt="Foto Profil"
            class="profil-foto"
          />
          <span id="infoText"></span>
          <button id="editProfilBtn" class="edit-profil-btn">
            Edit Profil
          </button>
        </div>
      </div>

      <div class="card" id="adminPanel" style="display: none">
        <h2>Tambah Siswa</h2>
        <input id="namaBaru" placeholder="Nama Lengkap" />
        <input id="absenBaru" type="number" placeholder="Nomor Absen" />
        <button id="btnTambahSiswa" class="btn-menarik">‚ûï Tambah Siswa</button>
        <h2>Import Semua Siswa (34)</h2>
        <button id="btnImportSiswa" class="btn-menarik">üì• Import Siswa</button>
        <h2>Ubah Absen Siswa</h2>
        <input id="absenLama" type="number" placeholder="Absen Lama" />
        <input id="absenBaruAdmin" type="number" placeholder="Absen Baru" />
        <button id="btnUbahAbsen" class="btn-menarik">üîÑ Ubah Absen</button>
        <h2>Daftar Siswa Sedang Login</h2>
        <div id="daftarSiswa"></div>
      </div>

      <div class="card">
        <h2>Jadwal Pelajaran</h2>
        <div id="jadwalButtons"></div>
        <div id="jadwalDetail"></div>
      </div>

      <div class="card">
        <h2>Daftar Tugas</h2>
        <div id="tugasList"></div>
        <div id="tambahTugasPanel" style="display: none; margin-top: 1rem">
          <input
            id="mapelBaru"
            placeholder="Mata Pelajaran (e.g., Matematika)"
          />
          <input id="tugasBaru" placeholder="Deskripsi Tugas" />
          <input id="deadlineBaru" type="date" />
          <button id="btnTambahTugas" class="btn-menarik">
            üìù Tambah Tugas
          </button>
        </div>
      </div>
    </main>

    <!-- Modal Edit Profil -->
    <div id="modalProfil">
      <div class="modal-content">
        <button class="close-modal" onclick="closeModal()">√ó</button>
        <h2>Edit Profil</h2>
        <label for="editNama">Nama Lengkap</label>
        <div class="keterangan">
          Masukkan nama lengkap Anda yang akan ditampilkan di dashboard.
        </div>
        <input id="editNama" placeholder="Nama Lengkap" />

        <label for="editAbsen">Nomor Absen Baru</label>
        <div class="keterangan">
          Masukkan nomor absen baru yang akan ditampilkan di dashboard (tidak
          mempengaruhi login).
        </div>
        <input id="editAbsen" type="number" placeholder="Nomor Absen Baru" />

        <label for="editAbsenLogin">Absen Login Baru</label>
        <div class="keterangan">
          Masukkan nomor absen baru untuk login ke akun ini. Gunakan absen ini
          saat login berikutnya.
        </div>
        <input
          id="editAbsenLogin"
          type="number"
          placeholder="Absen Login Baru (untuk login)"
        />

        <label for="editFoto">Foto Profil</label>
        <div class="keterangan">
          Upload foto baru (format gambar seperti JPG, PNG). Jika tidak diubah,
          foto lama tetap digunakan.
        </div>
        <input id="editFoto" type="file" accept="image/*" />
        <button
          id="hapusFotoBtn"
          type="button"
          style="
            background: #e74c3c;
            color: #fff;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 0.5rem;
          "
        >
          Hapus Foto
        </button>

        <button onclick="simpanProfil()" class="btn-menarik">üíæ Simpan</button>
      </div>
    </div>

    <footer>&copy; 2025 QUARTRIX. Semua hak cipta dilindungi.</footer>

    <!-- Firebase SDK dan Semua Kode JS -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
      import {
        getDatabase,
        ref,
        set,
        onValue,
        push,
        remove,
        get,
        onDisconnect,
      } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";
      import {
        getAuth,
        signInAnonymously,
      } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

      // Config Firebase Anda
      const firebaseConfig = {
        apiKey: "AIzaSyCP-Gha19gZ6ZkYCzZ9vh9QL2tKYmNVoCk",
        authDomain: "quartrix-eb95f.firebaseapp.com",
        databaseURL:
          "https://quartrix-eb95f-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "quartrix-eb95f",
        storageBucket: "quartrix-eb95f.firebasestorage.app",
        messagingSenderId: "589369640106",
        appId: "1:589369640106:web:7239da0bd98bae284fbcd3",
        measurementId: "G-HG1GL8D03G",
      };

      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);
      const auth = getAuth(app);

      // Login anonymous secara otomatis
      signInAnonymously(auth)
        .then(() => {
          console.log("Anonymous login berhasil");
          initApp(); // Jalankan app setelah auth berhasil
        })
        .catch((error) => {
          console.error("Error anonymous login:", error);
        });

      async function hapusTugasDanStatus(tugasKey) {
        // 1. Hapus tugas utama
        await remove(ref(db, "tugas/" + tugasKey));

        // 2. Ambil semua data tugasSelesai
        const selesaiSnapshot = await get(ref(db, "tugasSelesai"));
        if (!selesaiSnapshot.exists()) return;

        const selesaiData = selesaiSnapshot.val();

        // 3. Loop semua siswa
        for (const absenSiswa in selesaiData) {
          if (selesaiData[absenSiswa][tugasKey] !== undefined) {
            await remove(ref(db, `tugasSelesai/${absenSiswa}/${tugasKey}`));
          }
        }
      }

      function initApp() {
        /* LOGIN */
        const role = localStorage.getItem("role");
        const nama = localStorage.getItem("nama");
        const absen = localStorage.getItem("absen");
        if (!role || !nama || !absen) {
          document.body.innerHTML = `
    <div style="
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      background:#5a3e2b;
      color:#fff;
      font-family:Poppins,sans-serif;
      text-align:center;
      padding:2rem;
    ">
      <div>
        <h2>‚ö†Ô∏è Sesi Login Habis</h2>
        <p>Silakan login ulang untuk melanjutkan.</p>
        <button onclick="location.href='login.html'"
          style="
            margin-top:1rem;
            padding:12px 24px;
            border:none;
            border-radius:20px;
            font-weight:700;
            background:#ff8c42;
            color:#fff;
            cursor:pointer;
          ">
          üîë Login Ulang
        </button>
      </div>
    </div>
  `;
          return; // ‚õî STOP JS, tapi TIDAK BLANK
        }

        /* PROFIL */
        let profilData = {
          nama: nama,
          absen: absen,
          fotoURL:
            "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNTAiIHZpZXdCb3g9IjAgMCA1MCA1MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjUiIGN5PSIyNSIgcj0iMjUiIGZpbGw9IiNmZmY1ZTYiLz4KPHBhdGggZD0iTTI1IDI1QzI3LjIgMjUgMjkgMjIuMiAyOSAyMEMyOSAxNy44IDI3LjIgMTYgMjUgMTZDMTYuOCAxNiAxNSAxNy44IDE1IDIwQzE1IDIyLjIgMTYuOCAyNSAyNSAyNVoiIGZpbGw9IiMzZTJjMjMiLz4KPHBhdGggZD0iTTMwIDI1QzMwIDI4LjMgMjduMyAzMSAyNSAzMUMyMi43IDMxIDIwIDI4LjMgMjAgMjVDMjAgMjEuNyAyMi43IDE5IDI1IDE5QzI3LjMgMTkgMzAgMjEuNyAzMCAyNVoiIGZpbGw9IiMzZTJjMjMiLz4KPC9zdmc+",
        };
        const profilRef = ref(db, "siswa/" + absen);

        // Update UI awal dengan data localStorage
        updateProfilUI();

        // Load profil dari Firebase
        get(profilRef).then((snapshot) => {
          if (snapshot.exists()) {
            profilData = snapshot.val();
            updateProfilUI();
          }
        });

        function updateProfilUI() {
          const foto = document.getElementById("profilFoto");
          const infoText = document.getElementById("infoText");

          foto.src = profilData?.fotoURL || foto.src;

          if (role === "admin") {
            infoText.innerText = "üéâ Anda login sebagai ADMIN! üéâ";
          } else {
            const namaDisplay = profilData?.nama || nama || "Pengguna";
            const absenDisplay = profilData?.absen || absen || "-";
            infoText.innerText = `üëã Halo, ${namaDisplay}! Selamat datang di QUARTRIX (Absen ${absenDisplay}) üåü`;
          }
        }

        // Modal edit profil
        const editProfilBtn = document.getElementById("editProfilBtn");
        const modalProfil = document.getElementById("modalProfil");
        editProfilBtn.addEventListener("click", () => {
          if (role === "admin") return alert("Admin tidak bisa edit profil!");
          document.getElementById("editNama").value = profilData.nama;
          document.getElementById("editAbsen").value = profilData.absen;
          document.getElementById("editAbsenLogin").value = absen; // Absen login dari localStorage
          modalProfil.style.display = "flex";
        });

        window.closeModal = () => (modalProfil.style.display = "none");

        const hapusFotoBtn = document.getElementById("hapusFotoBtn");
        hapusFotoBtn.addEventListener("click", () => {
          if (role === "admin") return alert("Admin tidak bisa hapus foto!");
          const avatarDefaultURL =
            "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNTAiIHZpZXdCb3g9IjAgMCA1MCA1MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjUiIGN5PSIyNSIgcj0iMjUiIGZpbGw9IiNmZmY1ZTYiLz4KPHBhdGggZD0iTTI1IDI1QzI3LjIgMjUgMjkgMjIuMiAyOSAyMEMyOSAxNy44IDI3LjIgMTYgMjUgMTZDMTYuOCAxNiAxNSAxNy44IDE1IDIwQzE1IDIyLjIgMTYuOCAyNSAyNSAyNVoiIGZpbGw9IiMzZTJjMjMiLz4KPHBhdGggZD0iTTMwIDI1QzMwIDI4LjMgMjduMyAzMSAyNSAzMUMyMi43IDMxIDIwIDI4LjMgMjAgMjVDMjAgMjEuNyAyMi43IDE5IDI1IDE5QzI3LjMgMTkgMzAgMjEuNyAzMCAyNVoiIGZpbGw9IiMzZTJjMjMiLz4KPC9zdmc+";
          profilData.fotoURL = avatarDefaultURL;
          document.getElementById("profilFoto").src = avatarDefaultURL;
          alert("Foto profil berhasil dihapus dan dikembalikan ke default!");
        });

        window.simpanProfil = async () => {
          const newNama = document.getElementById("editNama").value.trim();
          const newAbsen = document.getElementById("editAbsen").value;
          const newAbsenLogin = document.getElementById("editAbsenLogin").value;
          const fotoFile = document.getElementById("editFoto").files[0];

          if (!newNama || !newAbsen || !newAbsenLogin)
            return alert("Isi semua field!");

          let fotoURL = profilData.fotoURL;
          if (fotoFile) {
            const reader = new FileReader();
            reader.onload = function (e) {
              fotoURL = e.target.result;
              updateProfil(newNama, newAbsen, newAbsenLogin, fotoURL);
            };
            reader.readAsDataURL(fotoFile);
            return; // Tunggu reader
          }

          updateProfil(newNama, newAbsen, newAbsenLogin, fotoURL);
        };

        function updateProfil(newNama, newAbsen, newAbsenLogin, fotoURL) {
          const oldAbsen = absen;

          // Cek apakah absen login baru sudah digunakan (kecuali jika sama dengan lama)
          if (newAbsenLogin !== oldAbsen) {
            const newRef = ref(db, "siswa/" + newAbsenLogin);
            get(newRef).then((snapshot) => {
              if (snapshot.exists()) {
                alert(
                  "Absen login baru sudah digunakan siswa lain! Pilih absen yang belum digunakan.",
                );
                return;
              }
              // Lanjutkan jika tidak ada
              proceedUpdate(
                newNama,
                newAbsen,
                newAbsenLogin,
                fotoURL,
                oldAbsen,
              );
            });
          } else {
            proceedUpdate(newNama, newAbsen, newAbsenLogin, fotoURL, oldAbsen);
          }
        }

        function proceedUpdate(
          newNama,
          newAbsen,
          newAbsenLogin,
          fotoURL,
          oldAbsen,
        ) {
          set(ref(db, "siswa/" + newAbsenLogin), {
            nama: newNama,
            absen: newAbsen,
            role: role,
            fotoURL: fotoURL,
          });

          localStorage.setItem("absen", newAbsenLogin);
          localStorage.setItem("nama", newNama);

          closeModal();
          alert("Profil berhasil disimpan!");

          if (newAbsenLogin !== oldAbsen) {
            remove(ref(db, "siswa/" + oldAbsen));
            alert(
              "Absen login telah diubah. Anda akan diarahkan ke halaman login untuk masuk dengan absen baru.",
            );
            localStorage.clear();
            location.href = "login.html";
          }
        }

        /* ADMIN */
        const adminPanel = document.getElementById("adminPanel");
        const tambahTugasPanel = document.getElementById("tambahTugasPanel");
        if (role === "admin") {
          adminPanel.style.display = "block";
          tambahTugasPanel.style.display = "block";
          editProfilBtn.style.display = "none"; // Admin tidak edit profil
          hapusFotoBtn.style.display = "none"; // Admin tidak hapus foto
          renderDaftarSiswa(); // Render daftar siswa sedang login untuk admin
          console.log("Panel admin dan tugas ditampilkan untuk role:", role);
        } else {
          console.log(
            "Role bukan admin, panel tidak ditampilkan. Role saat ini:",
            role,
          );
        }

        // Set user online saat login
        const onlineRef = ref(db, "online/" + absen);
        set(onlineRef, { nama: nama, role: role });
        onDisconnect(onlineRef).remove(); // Hapus saat disconnect

        function renderDaftarSiswa() {
          const daftarSiswaDiv = document.getElementById("daftarSiswa");

          onValue(ref(db, "online"), (snapshot) => {
            daftarSiswaDiv.innerHTML = "<ul>";

            snapshot.forEach((child) => {
              const absenKey = child.key;
              const data = child.val();

              daftarSiswaDiv.innerHTML += `
        <li>
          <span>${data.nama} (${data.role})</span>
          <span>Absen: ${absenKey} - Online</span>
        </li>
      `;
            });

            daftarSiswaDiv.innerHTML += "</ul>";
          });
        }

        /* IMPORT SISWA */
        const siswaData = [
          { nama: "AGUSTINE DYAH AYU RAHMADANI", absen: 1 },
          { nama: "AHMAD FAISHAL ZAUMAR", absen: 2 },
          { nama: "ALANA GEIZEL FAEDAH ALAM", absen: 3 },
          { nama: "ALYA NAFEEZA AZZAHRO", absen: 4 },
          { nama: "ANNISA PRIMADITA MUSAFA", absen: 5 },
          { nama: "ARYA ISSYA MAHENDRA", absen: 6 },
          { nama: "BERLIANA FAIRUZ IZDIHAR", absen: 7 },
          { nama: "CLEON ADLI DANENDRA OMAN", absen: 8 },
          { nama: "EIVEL FLORAYSA NADINDA ARDYALOVA", absen: 9 },
          { nama: "EVELYN GABRIEL ECHA CARERA", absen: 10 },
          { nama: "EZHAR AIRLANGGA RISTANSYAH", absen: 11 },
          { nama: "FALIA PUTRI ELLYZA", absen: 12 },
          { nama: "HANINDIA ASYAWA KAYNAHAYA", absen: 13 },
          { nama: "HANUNG ELYA PINANDITA", absen: 14 },
          { nama: "HELMY ARSYAD DARMAWAN", absen: 15 },
          { nama: "HENDARSO WIRATMOKO", absen: 16 },
          { nama: "JAGAD CAHYO ADY", absen: 17 },
          { nama: "JESSICA AFA MARTANIA", absen: 18 },
          { nama: "KAYLA AMANDA SYAMSAFINA", absen: 19 },
          { nama: "KEVIN APRILIO", absen: 20 },
          { nama: "LINTANG YULIDHA PUTRI", absen: 21 },
          { nama: "MUHAMMAD IBNU KHALDUN ALFAUZI", absen: 22 },
          { nama: "NABIL MAHIDARA ARTANTO", absen: 23 },
          { nama: "NABILA KIRANA CANTYA PUTRI", absen: 24 },
          { nama: "NADIA REYSSA IRVANA PUTRI", absen: 25 },
          { nama: "NATHANAEL ABIRA SETYO BUDI", absen: 26 },
          { nama: "NATHANIA NARESWARI BRAHMA PUTRI", absen: 27 },
          { nama: "NIDA ULHAQ NUR SYIFA", absen: 28 },
          { nama: "NISRINA MARYAM", absen: 29 },
          { nama: "PHILLIPUS ADE MAHENDRA PUTRA", absen: 30 },
          { nama: "PRISYA NOVI ANGGRAENI", absen: 31 },
          { nama: "RENITA ISNABILA", absen: 32 },
          { nama: "SEDYO SAKA PRATAMA", absen: 33 },
          { nama: "SELLA RAHMA YUNANDA", absen: 34 },
        ];

        // Ganti seluruh bagian btnImportSiswa.addEventListener dengan kode ini
        const btnImportSiswa = document.getElementById("btnImportSiswa");
        btnImportSiswa.addEventListener("click", async () => {
          // Pastikan 'async' di sini
          if (role !== "admin")
            return alert("Hanya admin yang bisa import siswa!");
          if (
            confirm(
              "Apakah Anda yakin ingin import semua 34 siswa? Ini akan menimpa data yang ada.",
            )
          ) {
            for (const siswa of siswaData) {
              // Cek apakah absen sudah ada
              const existingRef = ref(db, "siswa/" + siswa.absen);
              const snapshot = await get(existingRef); // 'await' sekarang di dalam fungsi async
              if (snapshot.exists()) {
                console.log(
                  `Absen ${siswa.absen} sudah ada, skip import untuk ${siswa.nama}`,
                );
                continue; // Skip jika sudah ada
              }
              // Jika belum ada, import
              await set(ref(db, "siswa/" + siswa.absen), {
                nama: siswa.nama,
                absen: siswa.absen,
                role: "siswa",
                fotoURL:
                  "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNTAiIHZpZXdCb3g9IjAgMCA1MCA1MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjUiIGN5PSIyNSIgcj0iMjUiIGZpbGw9IiNmZmY1ZTYiLz4KPHBhdGggZD0iTTI1IDI1QzI3LjIgMjUgMjkgMjIuMiAyOSAyMEMyOSAxNy44IDI3LjIgMTYgMjUgMTZDMTYuOCAxNiAxNSAxNy44IDE1IDIwQzE1IDIyLjIgMTYuOCAyNSAyNSAyNVoiIGZpbGw9IiMzZTJjMjMiLz4KPHBhdGggZD0iTTMwIDI1QzMwIDI4LjMgMjduMyAzMSAyNSAzMUMyMi43IDMxIDIwIDI4LjMgMjAgMjVDMjAgMjEuNyAyMi43IDE5IDI1IDE5QzI3LjMgMTkgMzAgMjEuNyAzMCAyNVoiIGZpbGw9IiMzZTJjMjMiLz4KPC9zdmc+",
              });
            }
            alert("Import selesai! Siswa dengan absen duplikat dilewati.");
          }
        });

        /* JADWAL MENARIK */
        const jadwalData = [
          { hari: "Senin", mataPelajaran: "PKWU", waktu: "08:15 - 09:45" },
          { hari: "Senin", mataPelajaran: "Kimia", waktu: "10:15 - 11:40" },
          {
            hari: "Senin",
            mataPelajaran: "Matematika Minat",
            waktu: "12:30 - 13:50",
          },
          { hari: "Senin", mataPelajaran: "Sejarah", waktu: "13:50 - 15:00" },
          {
            hari: "Selasa",
            mataPelajaran: "Bimbingan Konseling",
            waktu: "07:00 - 07:40",
          },
          {
            hari: "Selasa",
            mataPelajaran: "Matematika Wajib",
            waktu: "07:40 - 09:00",
          },
          {
            hari: "Selasa",
            mataPelajaran: "Penjaskes",
            waktu: "09:00 - 11:30",
          },
          { hari: "Selasa", mataPelajaran: "Fisika", waktu: "12:20 - 13:40" },
          {
            hari: "Selasa",
            mataPelajaran: "Bahasa Inggris",
            waktu: "13:40 - 15:00",
          },
          {
            hari: "Rabu",
            mataPelajaran: "Bahasa Indonesia",
            waktu: "07:00 - 08:20",
          },
          {
            hari: "Rabu",
            mataPelajaran: "Matematika Minat",
            waktu: "08:20 - 09:40",
          },
          {
            hari: "Rabu",
            mataPelajaran: "Seni Budaya",
            waktu: "10:10 - 11:30",
          },
          { hari: "Rabu", mataPelajaran: "Biologi", waktu: "12:20 - 13:40" },
          { hari: "Rabu", mataPelajaran: "Fisika", waktu: "13:40 - 15:00" },
          {
            hari: "Kamis",
            mataPelajaran: "Bahasa Jawa",
            waktu: "07:00 - 07:40",
          },
          { hari: "Kamis", mataPelajaran: "Kimia", waktu: "07:40 - 09:40" },
          { hari: "Kamis", mataPelajaran: "Biologi", waktu: "10:10 - 10:50" },
          { hari: "Kamis", mataPelajaran: "Agama", waktu: "12:20 - 13:40" },
          {
            hari: "Kamis",
            mataPelajaran: "Bahasa Indonesia",
            waktu: "13:40 - 15:00",
          },
          {
            hari: "Jumat",
            mataPelajaran: "Matematika Wajib",
            waktu: "07:00 - 08:30",
          },
          { hari: "Jumat", mataPelajaran: "BMQ", waktu: "08:30 - 09:15" },
          { hari: "Jumat", mataPelajaran: "PPKn", waktu: "09:45 - 11:15" },
        ];

        const hariList = [...new Set(jadwalData.map((j) => j.hari))];
        // Ambil daftar hari unik: ["Senin", "Selasa", "Rabu", "Kamis", "Jumat"]

        const jadwalButtons = document.getElementById("jadwalButtons");
        const jadwalDetail = document.getElementById("jadwalDetail");

        if (!jadwalData || jadwalData.length === 0) {
          jadwalDetail.innerHTML =
            "<p style='text-align:center;color:#666'>Jadwal belum tersedia.</p>";
        }

        // Fungsi untuk mendapatkan hari saat ini dalam bahasa Indonesia
        function getCurrentDay() {
          const days = [
            "Minggu",
            "Senin",
            "Selasa",
            "Rabu",
            "Kamis",
            "Jumat",
            "Sabtu",
          ];
          const today = new Date().getDay();
          return days[today];
        }

        const currentDay = getCurrentDay();
        let tombolHariIni = null;

        hariList.forEach((h) => {
          const b = document.createElement("button");
          b.textContent = h;
          b.className = "hari-btn";
          b.onclick = () => tampilJadwal(h, b);
          jadwalButtons.appendChild(b);

          if (h === currentDay) tombolHariIni = b;
        });

        if (tombolHariIni) {
          tampilJadwal(currentDay, tombolHariIni);
        } else {
          jadwalDetail.innerHTML =
            "<p style='text-align:center;color:#666;'>Tidak ada jadwal untuk hari ini.</p>";
        }

        function tampilJadwal(hari, btn) {
          document
            .querySelectorAll(".hari-btn")
            .forEach((b) => b.classList.remove("active"));
          btn.classList.add("active");
          jadwalDetail.innerHTML = "";
          jadwalData
            .filter((j) => j.hari === hari)
            .forEach((j) => {
              const card = document.createElement("div");
              card.className = "jadwal-card";
              card.innerHTML = `
        <div class="jadwal-mapel">${j.mataPelajaran}</div>
        <div class="jadwal-waktu">${j.waktu}</div>
      `;
              jadwalDetail.appendChild(card);
            });
        }

        /* TUGAS MENARIK DENGAN CHECKLIST */
        let tugasData = [];
        let tugasKeys = []; // Simpan key untuk hapus
        let tugasSelesai = {}; // Status selesai per tugas per siswa
        const tugasList = document.getElementById("tugasList");

        function renderTugas() {
          if (!tugasData || tugasData.length === 0) {
            tugasList.innerHTML =
              "<p style='text-align:center;color:#666'>Belum ada tugas üì≠</p>";
            return;
          }

          tugasList.innerHTML = "";
          const now = new Date();
          tugasData.forEach((t, index) => {
            const deadlineDate = new Date(t.deadline);
            const isExpired = deadlineDate < now; // Cek jika deadline sudah lewat

            // Jika expired, hapus dari Firebase secara otomatis
            if (isExpired) {
              hapusTugasDanStatus(tugasKeys[index]);
              return; // Skip render tugas ini
            }

            const card = document.createElement("div");
            card.className = "tugas-card";
            const isSelesai = tugasSelesai[tugasKeys[index]] || false;
            card.innerHTML = `
      <div class="tugas-mapel ${isSelesai ? "tugas-selesai" : ""}">${t.mapel}</div>
      <div class="tugas-desc ${isSelesai ? "tugas-selesai" : ""}">${t.deskripsi}</div>
      <div class="tugas-deadline ${isSelesai ? "tugas-selesai" : ""}">Deadline: ${t.deadline}</div>
      <div class="tugas-admin">
        ${role !== "admin" ? `<input type="checkbox" class="checkbox" ${isSelesai ? "checked" : ""} onchange="toggleSelesai('${tugasKeys[index]}', this.checked)">` : ""}
      </div>
    `;
            if (role === "admin") {
              const hapusBtn = document.createElement("button");
              hapusBtn.textContent = "Hapus";
              hapusBtn.className = "hapus-btn";
              hapusBtn.onclick = () => hapusTugas(tugasKeys[index]);
              card.querySelector(".tugas-admin").appendChild(hapusBtn);
            }
            tugasList.appendChild(card);
          });
        }

        // Load status selesai dari Firebase
        const selesaiRef = ref(db, "tugasSelesai/" + absen);
        onValue(selesaiRef, (snapshot) => {
          tugasSelesai = snapshot.val() || {};
          renderTugas(); // Render ulang saat status berubah
        });

        // Listen untuk perubahan tugas dari Firebase
        const tugasRef = ref(db, "tugas");
        onValue(tugasRef, (snapshot) => {
          const data = snapshot.val();
          tugasData = data ? Object.values(data) : [];
          tugasKeys = data ? Object.keys(data) : [];
          renderTugas();
          console.log("Tugas diperbarui:", tugasData);
        });

        // Event listener untuk tombol tambah tugas
        const btnTambahTugas = document.getElementById("btnTambahTugas");
        btnTambahTugas.addEventListener("click", function () {
          console.log("Tombol tambah tugas diklik");
          tambahTugas();
        });

        function tambahTugas() {
          console.log("Fungsi tambahTugas dipanggil");
          if (role !== "admin") {
            console.log("Role bukan admin:", role);
            alert("Hanya admin yang bisa menambah tugas!");
            return;
          }
          const mapelBaru = document.getElementById("mapelBaru");
          const tugasBaru = document.getElementById("tugasBaru");
          const deadlineBaru = document.getElementById("deadlineBaru");
          const mapel = mapelBaru.value.trim();
          const desc = tugasBaru.value.trim();
          const dead = deadlineBaru.value;
          if (!mapel || !desc || !dead) {
            alert("Isi semua field!");
            return;
          }
          const newTugasRef = push(tugasRef);
          set(newTugasRef, {
            mapel: mapel,
            deskripsi: desc,
            deadline: dead,
          });
          mapelBaru.value = "";
          tugasBaru.value = "";
          deadlineBaru.value = "";
          alert("Tugas berhasil dipublish kepada semua siswa!");
        }

        function hapusTugas(key) {
          if (role !== "admin") return;
          if (confirm("Yakin ingin hapus tugas ini?")) {
            hapusTugasDanStatus(key);
            alert("Tugas dan data pengerjaan siswa berhasil dihapus!");
          }
        }

        window.toggleSelesai = (key, checked) => {
          if (role === "admin") return;
          tugasSelesai[key] = checked;
          set(selesaiRef, tugasSelesai);
          renderTugas(); // Render ulang untuk efek visual
        };

        /* TAMBAH SISWA */
        const namaBaru = document.getElementById("namaBaru");
        const absenBaru = document.getElementById("absenBaru");
        const btnTambahSiswa = document.getElementById("btnTambahSiswa");
        btnTambahSiswa.addEventListener("click", async () => {
          const nama = namaBaru.value.trim().toUpperCase();
          const absen = absenBaru.value.trim();

          if (!nama || !absen) return alert("Isi semua field!");

          const existingRef = ref(db, "siswa/" + absen);
          const snapshot = await get(existingRef);
          if (snapshot.exists()) {
            return alert(
              "Absen sudah digunakan siswa lain! Pilih absen yang belum digunakan.",
            );
          }

          set(ref(db, "siswa/" + absen), {
            nama: nama,
            absen: absen,
            role: "siswa",
            fotoURL: "",
          });

          namaBaru.value = "";
          absenBaru.value = "";
          alert("Siswa berhasil ditambahkan ke Firebase!");
        });

        /* UBAH ABSEN SISWA (ADMIN) */
        const absenLama = document.getElementById("absenLama");
        const absenBaruAdmin = document.getElementById("absenBaruAdmin");
        const btnUbahAbsen = document.getElementById("btnUbahAbsen");
        btnUbahAbsen.addEventListener("click", async () => {
          const lama = absenLama.value;
          const baru = absenBaruAdmin.value;

          if (!lama || !baru) return alert("Isi semua field!");

          const newRef = ref(db, "siswa/" + baru);
          const newSnapshot = await get(newRef);
          if (newSnapshot.exists()) {
            return alert(
              "Absen baru sudah digunakan siswa lain! Pilih absen yang belum digunakan.",
            );
          }

          const oldRef = ref(db, "siswa/" + lama);
          const snapshot = await get(oldRef);

          if (!snapshot.exists()) {
            alert("Siswa tidak ditemukan");
            return;
          }

          const dataLama = snapshot.val();
          // Update absen di objek
          dataLama.absen = baru; // Tambahkan ini

          // pindahkan data
          await set(ref(db, "siswa/" + baru), dataLama);
          await remove(oldRef);

          alert("Absen berhasil diubah!");
          absenLama.value = "";
          absenBaruAdmin.value = "";
        });

        /* LOGOUT */
        const logoutBtn = document.querySelector(".logout");
        logoutBtn.addEventListener("click", function () {
          localStorage.clear();
          location.href = "login.html";
        });
      }
    </script>
  </body>
</html>

