<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Dashboard - QUARTRIX</title>
<link rel="icon" href="https://i.ibb.co.com/7xxVWwH7/IMG-8428.png">

<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:'Poppins',sans-serif}
body{background:#5a3e2b;color:#fff5e6;min-height:100vh;display:flex;flex-direction:column}
header{background:#ff8c42;padding:1.5rem 2rem;display:flex;justify-content:space-between;align-items:center}
header a{color:#fff5e6;text-decoration:none;letter-spacing:2px}
.logout{background:#3e2c23;color:#fff;border:none;padding:10px 18px;border-radius:8px;font-weight:600;cursor:pointer}
main{max-width:1000px;margin:auto;padding:2rem;flex:1}
.card{background:#fff5e6;color:#3e2c23;border-radius:16px;padding:2rem;margin-bottom:2rem;box-shadow:0 10px 25px rgba(0,0,0,.35)}
.card h2{margin-bottom:1rem;color:#5a3e2b}
ul{list-style:none}
li{padding:10px;border-bottom:1px solid #ddd;font-weight:600;display:flex;justify-content:space-between;align-items:center}

/* JADWAL MENARIK */
#jadwalButtons{display:flex;gap:.5rem;flex-wrap:wrap;margin-bottom:1rem}
.hari-btn{background:#ff8c42;color:#fff;border:none;padding:8px 16px;border-radius:8px;font-weight:600;cursor:pointer}
.hari-btn.active{background:#3e2c23}
#jadwalDetail{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:1rem;margin-top:1rem}
.jadwal-card{background:#f9f9f9;border:1px solid #ddd;border-radius:10px;padding:1rem;text-align:center;box-shadow:0 4px 10px rgba(0,0,0,0.1);transition:transform 0.3s}
.jadwal-card:hover{transform:translateY(-5px)}
.jadwal-mapel{font-weight:700;color:#ff8c42;font-size:1.1rem;margin-bottom:0.5rem}
.jadwal-waktu{color:#666;font-size:0.9rem;display:flex;align-items:center;justify-content:center;gap:0.5rem}
.jadwal-waktu::before{content:'⏰';font-size:1rem}

/* ADMIN */
#adminPanel input,#tambahTugasPanel input{
  width:100%;padding:10px;margin:.4rem 0;border-radius:8px;border:1px solid #ccc
}
button{cursor:pointer}
.hapus-btn{background:#e74c3c;color:#fff;border:none;padding:5px 10px;border-radius:5px;font-size:0.8rem;cursor:pointer;margin-left:10px}
.hapus-btn:hover{background:#c0392b}

/* TUGAS MENARIK */
.tugas-card{background:#f9f9f9;border:1px solid #ddd;border-radius:10px;padding:1rem;margin-bottom:1rem;display:flex;flex-direction:column;gap:0.5rem}
.tugas-mapel{font-weight:700;color:#ff8c42;font-size:1.1rem}
.tugas-desc{color:#333}
.tugas-deadline{color:#666;font-size:0.9rem}
.tugas-admin{display:flex;justify-content:space-between;align-items:center}
.tugas-siswa{display:flex;justify-content:space-between;align-items:flex-start}
.checkbox-selesai{margin-top:0.5rem;transform:scale(1.2);cursor:pointer}

/* PROFIL */
#info{display:flex;align-items:center;gap:1rem}
.profil-foto{width:50px;height:50px;border-radius:50%;object-fit:cover;border:2px solid #ff8c42}
.edit-profil-btn{background:#3498db;color:#fff;border:none;padding:8px 16px;border-radius:8px;font-weight:600;cursor:pointer;margin-left:auto}
.edit-profil-btn:hover{background:#2980b9}
#modalProfil{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);justify-content:center;align-items:center;z-index:1000}
.modal-content{background:#fff;border-radius:10px;padding:2rem;max-width:400px;width:90%;text-align:center}
.modal-content input{margin:0.5rem 0;width:100%;padding:10px;border-radius:8px;border:1px solid #ccc}
.modal-content button{margin-top:1rem}
.close-modal{position:absolute;top:10px;right:10px;background:#e74c3c;color:#fff;border:none;padding:5px 10px;border-radius:50%;cursor:pointer}
footer{text-align:center;padding:1rem;background:#3e2c23}
</style>
</head>

<body>

<header>
  <h1><a href="index.html">QUARTRIX</a></h1>
  <button class="logout">Logout</button>
</header>

<main>

<div class="card">
  <div id="info">
    <img id="profilFoto" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNTAiIHZpZXdCb3g9IjAgMCA1MCA1MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjUiIGN5PSIyNSIgcj0iMjUiIGZpbGw9IiNmZmY1ZTYiLz4KPHBhdGggZD0iTTI1IDI1QzI3LjIgMjUgMjkgMjIuMiAyOSAyMEMyOSAxNy44IDI3LjIgMTYgMjUgMTZDMTYuOCAxNiAxNSAxNy44IDE1IDIwQzE1IDIyLjIgMTYuOCAyNSAyNSAyNVoiIGZpbGw9IiMzZTJjMjMiLz4KPHBhdGggZD0iTTMwIDI1QzMwIDI4LjMgMjcuMyAzMSAyNSAzMUMyMi43IDMxIDIwIDI4LjMgMjAgMjVDMjAgMjEuNyAyMi43IDE5IDI1IDE5QzI3LjMgMTkgMzAgMjEuNyAzMCAyNVoiIGZpbGw9IiMzZTJjMjMiLz4KPC9zdmc+" alt="Foto Profil" class="profil-foto">
    <span id="infoText"></span>
    <button id="editProfilBtn" class="edit-profil-btn">Edit Profil</button>
  </div>
</div>

<div class="card" id="adminPanel" style="display:none">
  <h2>Tambah Siswa</h2>
  <input id="namaBaru" placeholder="Nama Lengkap">
  <input id="absenBaru" type="number" placeholder="Nomor Absen">
  <button id="btnTambahSiswa">Tambah</button>
</div>

<div class="card">
  <h2>Jadwal Pelajaran</h2>
  <div id="jadwalButtons"></div>
  <div id="jadwalDetail"></div>
</div>

<div class="card">
  <h2>Daftar Tugas</h2>
  <div id="tugasList"></div>
  <div id="tambahTugasPanel" style="display:none;margin-top:1rem">
    <input id="mapelBaru" placeholder="Mata Pelajaran (e.g., Matematika)">
    <input id="tugasBaru" placeholder="Deskripsi Tugas">
    <input id="deadlineBaru" type="date">
    <button id="btnTambahTugas">Tambah Tugas</button>
  </div>
</div>

</main>

<!-- Modal Edit Profil -->
<div id="modalProfil">
  <div class="modal-content">
    <button class="close-modal" onclick="closeModal()">×</button>
    <h2>Edit Profil</h2>
    <input id="editNama" placeholder="Nama Lengkap">
    <input id="editAbsen" type="number" placeholder="Nomor Absen">
    <input id="editFoto" type="file" accept="image/*">
    <button onclick="simpanProfil()">Simpan</button>
  </div>
</div>

<footer>&copy; 2025 QUARTRIX</footer>

<!-- Firebase SDK dan Semua Kode JS -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
  import { getDatabase, ref, set, onValue, push, remove, get } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";
  import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

  // Config Firebase Anda
  const firebaseConfig = {
    apiKey: "AIzaSyCP-Gha19gZ6ZkYCzZ9vh9QL2tKYmNVoCk",
    authDomain: "quartrix-eb95f.firebaseapp.com",
    databaseURL: "https://quartrix-eb95f-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "quartrix-eb95f",
    storageBucket: "quartrix-eb95f.firebasestorage.app",
    messagingSenderId: "589369640106",
    appId: "1:589369640106:web:7239da0bd98bae284fbcd3",
    measurementId: "G-HG1GL8D03G"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const auth = getAuth(app);

  // Login anonymous secara otomatis
  signInAnonymously(auth)
    .then(() => {
      console.log("Anonymous login berhasil");
      initApp(); // Jalankan app setelah auth berhasil
    })
    .catch((error) => {
      console.error("Error anonymous login:", error);
    });

  function initApp() {
    /* LOGIN */
    const role = localStorage.getItem("role");
    const nama = localStorage.getItem("nama");
    const absen = localStorage.getItem("absen");
    if(!role) location.href="login.html";

    /* PROFIL */
    let profilData = { nama: nama, absen: absen, fotoURL: "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNTAiIHZpZXdCb3g9IjAgMCA1MCA1MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjUiIGN5PSIyNSIgcj0iMjUiIGZpbGw9IiNmZmY1ZTYiLz4KPHBhdGggZD0iTTI1IDI1QzI3LjIgMjUgMjkgMjIuMiAyOSAyMEMyOSAxNy44IDI3LjIgMTYgMjUgMTZDMTYuOCAxNiAxNSAxNy44IDE1IDIwQzE1IDIyLjIgMTYuOCAyNSAyNSAyNVoiIGZpbGw9IiMzZTJjMjMiLz4KPHBhdGggZD0iTTMwIDI1QzMwIDI4LjMgMjcuMyAzMSAyNSAzMUMyMi43IDMxIDIwIDI4LjMgMjAgMjVDMjAgMjEuNyAyMi43IDE5IDI1IDE5QzI3LjMgMTkgMzAgMjEuNyAzMCAyNVoiIGZpbGw9IiMzZTJjMjMiLz4KPC9zdmc+" };
    const profilRef = ref(db, 'siswa/' + absen);

    // Load profil dari Firebase
    get(profilRef).then((snapshot) => {
      if (snapshot.exists()) {
        profilData = snapshot.val();
        updateProfilUI();
      }
    });

    function updateProfilUI() {
      document.getElementById("profilFoto").src = profilData.fotoURL;
      document.getElementById("infoText").innerText = role==="admin"
        ? "Anda login sebagai ADMIN"
        : `Selamat datang, ${profilData.nama} (Absen ${profilData.absen})`;
    }

    // Modal edit profil
    const editProfilBtn = document.getElementById("editProfilBtn");
    const modalProfil = document.getElementById("modalProfil");
    editProfilBtn.addEventListener("click", () => {
      if(role === "admin") return alert("Admin tidak bisa edit profil!");
      document.getElementById("editNama").value = profilData.nama;
      document.getElementById("editAbsen").value = profilData.absen;
      modalProfil.style.display = "flex";
    });

    window.closeModal = () => modalProfil.style.display = "none";

    window.simpanProfil = () => {
      const newNama = document.getElementById("editNama").value.trim();
      const newAbsen = document.getElementById("editAbsen").value;
      const fotoFile = document.getElementById("editFoto").files[0];

      if(!newNama || !newAbsen) return alert("Isi nama dan absen!");

      let fotoURL = profilData.fotoURL;
      if(fotoFile) {
        const reader = new FileReader();
        reader.onload = function(e) {
          fotoURL = e.target.result;
          profilData = { nama: newNama, absen: newAbsen, fotoURL: fotoURL };
          set(profilRef, profilData);
          updateProfilUI();
          closeModal();
          alert("Profil berhasil disimpan!");
        };
        reader.readAsDataURL(fotoFile);
        return; // Tunggu reader selesai
      }

      profilData = { nama: newNama, absen: newAbsen, fotoURL: fotoURL };
      set(profilRef, profilData);
      updateProfilUI();
      closeModal();
      alert("Profil berhasil disimpan!");
    };

    /* ADMIN */
    const adminPanel = document.getElementById("adminPanel");
    const tambahTugasPanel = document.getElementById("tambahTugasPanel");
    if(role==="admin"){
      adminPanel.style.display="block";
      tambahTugasPanel.style.display="block";
      editProfilBtn.style.display = "none"; // Admin tidak edit profil
      console.log("Panel admin dan tugas ditampilkan untuk role:", role);
    } else {
      console.log("Role bukan admin, panel tidak ditampilkan. Role saat ini:", role);
    }

    /* SISWA DATA (untuk login, tapi tidak ditampilkan) */
    let siswaData = JSON.parse(localStorage.getItem("siswaData")) || [];

    /* JADWAL MENARIK */
    const jadwalData = [
     { hari: "Senin", mataPelajaran: "PKWU", waktu: "08:15 - 09:45" },
      { hari: "Senin", mataPelajaran: "Kimia", waktu: "10:15 - 11:40" },
      { hari: "Senin", mataPelajaran: "Matematika Minat", waktu: "12:30 - 13:50" },
      { hari: "Senin", mataPelajaran: "Sejarah", waktu: "13:50 - 15:00" },
      { hari: "Selasa", mataPelajaran: "Bimbingan Konseling", waktu: "07:00 - 07:40" },
      { hari: "Selasa", mataPelajaran: "Matematika Wajib", waktu: "07:40 - 09:00" },
      { hari: "Selasa", mataPelajaran: "Penjaskes", waktu: "09:00 - 11:30" },
      { hari: "Selasa", mataPelajaran: "Fisika", waktu: "12:20 - 13:40" },
      { hari: "Selasa", mataPelajaran: "Bahasa Inggris", waktu: "13:40 - 15:00" },
      { hari: "Rabu", mataPelajaran: "Bahasa Indonesia", waktu: "07:00 - 08:20" },
      { hari: "Rabu", mataPelajaran: "Matematika Minat", waktu: "08:20 - 09:40" },
      { hari: "Rabu", mataPelajaran: "Seni Budaya", waktu: "10:10 - 11:30" },
      { hari: "Rabu", mataPelajaran: "Biologi", waktu: "12:20 - 13:40" },
      { hari: "Rabu", mataPelajaran: "Fisika", waktu: "13:40 - 15:00" },
      { hari: "Kamis", mataPelajaran: "Bahasa Jawa", waktu: "07:00 - 07:40" },
      { hari: "Kamis", mataPelajaran: "Kimia", waktu: "07:40 - 09:40" },
      { hari: "Kamis", mataPelajaran: "Biologi", waktu: "10:10 - 10:50" },
      { hari: "Kamis", mataPelajaran: "Agama", waktu: "12:20 - 13:40" },
      { hari: "Kamis", mataPelajaran: "Bahasa Indonesia", waktu: "13:40 - 15:00" },
      { hari: "Jumat", mataPelajaran: "Matematika Wajib", waktu: "07:00 - 08:30" },
      { hari: "Jumat", mataPelajaran: "BMQ", waktu: "08:30 - 09:15" },
      { hari: "Jumat", mataPelajaran: "PPKn", waktu: "09:45 - 11:15" }
    ];
    
    const hariList = [...new Set(jadwalData.map(j => j.hari))]; 
    // Ambil daftar hari unik: ["Senin", "Selasa", "Rabu", "Kamis", "Jumat"]

    const jadwalButtons = document.getElementById("jadwalButtons");
    const jadwalDetail = document.getElementById("jadwalDetail");

    hariList.forEach(h => {
      const b = document.createElement("button");
      b.textContent = h;
      b.className = "hari-btn";
      b.onclick = () => tampilJadwal(h, b);
      jadwalButtons.appendChild(b);
    });

    function tampilJadwal(hari, btn) {
      document.querySelectorAll(".hari-btn").forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      jadwalDetail.innerHTML = "";
      jadwalData
        .filter(j => j.hari === hari)
        .forEach(j => {
          const card = document.createElement("div");
          card.className = "jadwal-card";
          card.innerHTML = `
            <div class="jadwal-mapel">${j.mataPelajaran}</div>
            <div class="jadwal-waktu">${j.waktu}</div>
          `;
          jadwalDetail.appendChild(card);
        });
    }

    // auto buka hari pertama
    tampilJadwal(hariList[0], jadwalButtons.children[0]);

    /* TUGAS - Menggunakan Firebase */
    let tugasData = [];
    let tugasKeys = []; // Simpan key untuk hapus
    const tugasList = document.getElementById("tugasList");

    function renderTugas(){
      tugasList.innerHTML="";
      tugasData.forEach((t, index) => {
        const card = document.createElement("div");
        card.className = "tugas-card";
        card.innerHTML = `
          <div class="tugas-mapel">${t.mapel}</div>
          <div class="tugas-desc">${t.deskripsi}</div>
          <div class="tugas-deadline">Deadline: ${t.deadline}</div>
        `;
        if(role === "admin") {
          const hapusBtn = document.createElement("button");
          hapusBtn.textContent = "Hapus";
          hapusBtn.className = "hapus-btn";
          hapusBtn.onclick = () => hapusTugas(tugasKeys[index]);
          card.innerHTML += '<div class="tugas-admin"></div>';
          card.querySelector('.tugas-admin').appendChild(hapusBtn);
        }
        tugasList.appendChild(card);
      });
    }

    // Listen untuk perubahan real-time dari Firebase
    const tugasRef = ref(db, 'tugas');
    onValue(tugasRef, (snapshot) => {
      const data = snapshot.val();
      tugasData = data ? Object.values(data) : [];
      tugasKeys = data ? Object.keys(data) : [];
      renderTugas();
      console.log("Tugas diperbarui:", tugasData);
    });

    // Event listener untuk tombol tambah tugas
    const btnTambahTugas = document.getElementById("btnTambahTugas");
    btnTambahTugas.addEventListener("click", function() {
      console.log("Tombol tambah tugas diklik");
      tambahTugas();
    });

    function tambahTugas(){
      console.log("Fungsi tambahTugas dipanggil");
      if(role !== "admin") {
        console.log("Role bukan admin:", role);
        alert("Hanya admin yang bisa menambah tugas!");
        return;
      }
      const mapelBaru = document.getElementById("mapelBaru");
      const tugasBaru = document.getElementById("tugasBaru");
      const deadlineBaru = document.getElementById("deadlineBaru");
      const mapel = mapelBaru.value.trim();
      const desc = tugasBaru.value.trim();
      const dead = deadlineBaru.value;
      if(!mapel || !desc || !dead) {
        alert("Isi semua field!");
        return;
      }
      const newTugasRef = push(tugasRef);
      set(newTugasRef, {
        mapel: mapel,
        deskripsi: desc,
        deadline: dead
      });
      mapelBaru.value="";tugasBaru.value="";deadlineBaru.value="";
      alert("Tugas berhasil dipublish kepada semua siswa!");
    }

    function hapusTugas(key) {
      if(role !== "admin") return;
      if(confirm("Yakin ingin hapus tugas ini?")) {
        remove(ref(db, 'tugas/' + key));
        alert("Tugas berhasil dihapus!");
      }
    }

    /* TAMBAH SISWA */
    const namaBaru = document.getElementById("namaBaru");
    const absenBaru = document.getElementById("absenBaru");
    const btnTambahSiswa = document.getElementById("btnTambahSiswa");
    btnTambahSiswa.addEventListener("click", function() {
      const nama = namaBaru.value.trim().toUpperCase();
      const abs = +absenBaru.value;
      if(!nama || !abs) return alert("Isi semua field!");
      siswaData.push({nama, absen: abs});
      namaBaru.value="";absenBaru.value="";
      localStorage.setItem("siswaData",JSON.stringify(siswaData));
      alert("Siswa berhasil ditambahkan!");
    });

    /* LOGOUT */
    const logoutBtn = document.querySelector(".logout");
    logoutBtn.addEventListener("click", function() {
      localStorage.clear();
      location.href="login.html";
    });
  }
</script>

</body>
</html>




